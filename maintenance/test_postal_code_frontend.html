<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto Postal Code</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2>Test Auto Postal Code</h2>
        
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Provinsi</label>
                <select class="form-select" id="province_id">
                    <option value="">Pilih Provinsi</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Kabupaten/Kota</label>
                <select class="form-select" id="regency_id" disabled>
                    <option value="">Pilih Kabupaten/Kota</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Kecamatan</label>
                <select class="form-select" id="district_id" disabled>
                    <option value="">Pilih Kecamatan</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Desa/Kelurahan</label>
                <select class="form-select" id="village_id" disabled>
                    <option value="">Pilih Desa/Kelurahan</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">Kode Pos (Auto-fill)</label>
                <input type="text" class="form-control" id="postal_code" readonly placeholder="Akan terisi otomatis">
            </div>
        </div>
        
        <div class="mt-3">
            <div id="result" class="alert alert-info" style="display: none;"></div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Load provinces
        loadProvinces();
        
        // Event handlers
        $('#province_id').on('change', function() {
            var provinceId = $(this).val();
            if (provinceId) {
                loadRegencies(provinceId);
                $('#regency_id, #district_id, #village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            } else {
                $('#regency_id, #district_id, #village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            }
        });
        
        $('#regency_id').on('change', function() {
            var regencyId = $(this).val();
            if (regencyId) {
                loadDistricts(regencyId);
                $('#district_id, #village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            } else {
                $('#district_id, #village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            }
        });
        
        $('#district_id').on('change', function() {
            var districtId = $(this).val();
            if (districtId) {
                loadVillages(districtId);
                $('#village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            } else {
                $('#village_id').prop('disabled', true).val('');
                $('#postal_code').val('');
            }
        });
        
        // Auto-load postal code when village is selected
        $('#village_id').on('change', function() {
            var villageId = $(this).val();
            if (villageId) {
                loadPostalCode(villageId);
            } else {
                $('#postal_code').val('');
            }
        });
        
        function loadProvinces() {
            $.ajax({
                url: 'index.php?page=address&action=get-provinces',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status == "success") {
                        var $select = $('#province_id');
                        $select.find('option:not(:first)').remove();
                        
                        response.data.forEach(function(province) {
                            $select.append('<option value="' + province.id + '">' + province.name + '</option>');
                        });
                        
                        $('#result').html('✅ Provinces loaded: ' + response.data.length + ' provinces').show();
                    } else {
                        $('#result').html('❌ Error loading provinces').show();
                    }
                },
                error: function() {
                    $('#result').html('❌ Network error loading provinces').show();
                }
            });
        }
        
        function loadRegencies(provinceId) {
            $.ajax({
                url: 'index.php?page=address&action=get-regencies&province_id=' + provinceId,
                type: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    $('#regency_id').prop('disabled', true);
                },
                success: function(response) {
                    if (response.status == "success") {
                        var $select = $('#regency_id');
                        $select.find('option:not(:first)').remove();
                        
                        response.data.forEach(function(regency) {
                            $select.append('<option value="' + regency.id + '">' + regency.name + '</option>');
                        });
                        
                        $select.prop('disabled', false);
                        $('#result').html('✅ Regencies loaded: ' + response.data.length + ' regencies').show();
                    } else {
                        $('#result').html('❌ Error loading regencies').show();
                    }
                },
                error: function() {
                    $('#result').html('❌ Network error loading regencies').show();
                }
            });
        }
        
        function loadDistricts(regencyId) {
            $.ajax({
                url: 'index.php?page=address&action=get-districts&regency_id=' + regencyId,
                type: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    $('#district_id').prop('disabled', true);
                },
                success: function(response) {
                    if (response.status == "success") {
                        var $select = $('#district_id');
                        $select.find('option:not(:first)').remove();
                        
                        response.data.forEach(function(district) {
                            $select.append('<option value="' + district.id + '">' + district.name + '</option>');
                        });
                        
                        $select.prop('disabled', false);
                        $('#result').html('✅ Districts loaded: ' + response.data.length + ' districts').show();
                    } else {
                        $('#result').html('❌ Error loading districts').show();
                    }
                },
                error: function() {
                    $('#result').html('❌ Network error loading districts').show();
                }
            });
        }
        
        function loadVillages(districtId) {
            $.ajax({
                url: 'index.php?page=address&action=get-villages&district_id=' + districtId,
                type: 'GET',
                dataType: 'json',
                beforeSend: function() {
                    $('#village_id').prop('disabled', true);
                },
                success: function(response) {
                    if (response.status == "success") {
                        var $select = $('#village_id');
                        $select.find('option:not(:first)').remove();
                        
                        response.data.forEach(function(village) {
                            // Store postal code as data attribute
                            var option = '<option value="' + village.id + '"';
                            if (village.postal_code) {
                                option += ' data-postal-code="' + village.postal_code + '"';
                            }
                            option += '>' + village.name + '</option>';
                            $select.append(option);
                        });
                        
                        $select.prop('disabled', false);
                        $('#result').html('✅ Villages loaded: ' + response.data.length + ' villages').show();
                    } else {
                        $('#result').html('❌ Error loading villages').show();
                    }
                },
                error: function() {
                    $('#result').html('❌ Network error loading villages').show();
                }
            });
        }
        
        function loadPostalCode(villageId) {
            // First try to get from data attribute (faster)
            var $selectedOption = $('#village_id option[value="' + villageId + '"]');
            var postalCode = $selectedOption.data('postal-code');
            
            if (postalCode) {
                $('#postal_code').val(postalCode);
                $('#result').html('✅ Postal code auto-filled: ' + postalCode).show();
                return;
            }
            
            // If not in data attribute, fetch from server
            $.ajax({
                url: 'index.php?page=address&action=get-postal-code&village_id=' + villageId,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.status == "success") {
                        $('#postal_code').val(response.data.postal_code);
                        // Update data attribute for future use
                        $selectedOption.attr('data-postal-code', response.data.postal_code);
                        $('#result').html('✅ Postal code fetched: ' + response.data.postal_code).show();
                    } else {
                        // Clear postal code if not found
                        $('#postal_code').val('');
                        $('#result').html('⚠️ Postal code not found').show();
                    }
                },
                error: function() {
                    // Clear postal code on error
                    $('#postal_code').val('');
                    $('#result').html('❌ Error fetching postal code').show();
                }
            });
        }
    });
    </script>
</body>
</html>
